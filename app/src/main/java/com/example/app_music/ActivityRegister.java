package com.example.app_music;

import android.content.Intent;
import android.os.Bundle;
import android.text.TextUtils;
import android.util.Patterns;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import android.widget.Toast;

import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;

import com.example.app_music.Utils.SupabaseManagerUser;

/**
 * üßæ M√†n h√¨nh ƒêƒÉng k√Ω ng∆∞·ªùi d√πng
 */
public class ActivityRegister extends AppCompatActivity {

    private EditText edtFullname, edtEmail, edtPassword, edtConfirmPassword;
    private Button btnRegister;
    private TextView tvGoToLogin;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_register);

        // üëâ √Ånh x·∫° view
        bindingView();
        // üëâ X·ª≠ l√Ω s·ª± ki·ªán
        setupEvents();
    }

    // √Ånh x·∫° view
    private void bindingView() {
        edtFullname = findViewById(R.id.register_edt_fullname);
        edtEmail = findViewById(R.id.register_edt_email);
        edtPassword = findViewById(R.id.register_edt_password);
        edtConfirmPassword = findViewById(R.id.register_edt_confirm_password);
        btnRegister = findViewById(R.id.register_btn_register);
        tvGoToLogin = findViewById(R.id.register_tv_go_to_login);
    }

    // Thi·∫øt l·∫≠p s·ª± ki·ªán
    private void setupEvents() {
        btnRegister.setOnClickListener(v -> registerUser());
        tvGoToLogin.setOnClickListener(v -> {
            Intent intent = new Intent(ActivityRegister.this, ActivityLogin.class);
            startActivity(intent);
            finish();
        });
    }

    // H√†m x·ª≠ l√Ω ƒëƒÉng k√Ω
    private void registerUser() {
        String fullname = edtFullname.getText().toString().trim();
        String email = edtEmail.getText().toString().trim();
        String password = edtPassword.getText().toString().trim();
        String confirmPassword = edtConfirmPassword.getText().toString().trim();

        // ‚úÖ Ki·ªÉm tra h·ª£p l·ªá
        if (!validateInput(fullname, email, password, confirmPassword)) return;

        // üëâ G·ªçi Supabase API
        new Thread(() -> {
            boolean success = SupabaseManagerUser.registerUser(fullname, email, password);
            runOnUiThread(() -> {
                if (success) {
                    Toast.makeText(this, "ƒêƒÉng k√Ω th√†nh c√¥ng!", Toast.LENGTH_SHORT).show();
                    startActivity(new Intent(this, ActivityLogin.class));
                    finish();
                } else {
                    Toast.makeText(this, "Email ƒë√£ t·ªìn t·∫°i ho·∫∑c l·ªói server!", Toast.LENGTH_SHORT).show();
                }
            });
        }).start();
    }

    // H√†m ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
    private boolean validateInput(String fullname, String email, String password, String confirmPassword) {
        if (TextUtils.isEmpty(fullname) || TextUtils.isEmpty(email)
                || TextUtils.isEmpty(password) || TextUtils.isEmpty(confirmPassword)) {
            Toast.makeText(this, "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin", Toast.LENGTH_SHORT).show();
            return false;
        }

        if (!Patterns.EMAIL_ADDRESS.matcher(email).matches()) {
            Toast.makeText(this, "Email kh√¥ng h·ª£p l·ªá", Toast.LENGTH_SHORT).show();
            return false;
        }

        if (password.length() < 6) {
            Toast.makeText(this, "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±", Toast.LENGTH_SHORT).show();
            return false;
        }

        if (!password.equals(confirmPassword)) {
            Toast.makeText(this, "M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng tr√πng kh·ªõp", Toast.LENGTH_SHORT).show();
            return false;
        }

        return true;
    }
}
